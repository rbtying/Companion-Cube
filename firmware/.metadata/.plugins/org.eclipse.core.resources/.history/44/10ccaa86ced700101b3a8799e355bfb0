/*
 * PID.cpp
 *
 *  Created on: Sep 5, 2011
 *      Author: rbtying
 */

#include "PID.h"

PID::PID(PID_Params * p) {
	m_param = p;
}

void PID::setInput(double in) {
	m_param->input = in;
}

double PID::getOutput() {
	return m_param->output;
}

void PID::clear() {
	m_param->error = 0;
	m_param->previous = 0;
	m_param->accumulated = 0;
	m_param->input = 0;
	m_param->output = 0;
}

void PID::process(double dt) {
	// calculate the error
	m_param->error = m_param->set - m_param->input;

	// integrate the error using Riemann sum
	m_param->accumulated += m_param->error * dt;

	// limit the integrated error to +/- accLimit
	m_param->accumulated = constrain(m_param->accumulated,
			-(m_param->accLimit), m_param->accLimit);

	// do the actual PID calculation
	m_param->output = m_param->proportional * m_param->error
			+ m_param->integral * m_param->accumulated + m_param->derivative
			* (m_param->error - m_param->previous) / dt;

	// save the current error for next time to caluclate derivative
	m_param->previous = m_param->error;
}
